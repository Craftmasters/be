<?php
/**
 * Bullseye account module.
 */

/**
 * Implements hook_menu().
 */
function bullseye_account_menu() {
  $items = array();

  $items['accounts/new/lead'] = array(
    'title' => t('Add New Lead'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bullseye_account_new_form'),
    'access arguments' => array('add account'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['accounts/new/prospect'] = array(
    'title' => t('Add New Prospect'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bullseye_account_new_form'),
    'access arguments' => array('add account'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['accounts/new/opportunity'] = array(
    'title' => t('Add New Opportunity'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bullseye_account_new_form'),
    'access arguments' => array('add account'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['accounts/new/deal-in-progress'] = array(
    'title' => t('Add New Deal in Progress'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bullseye_account_new_form'),
    'access arguments' => array('add account'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['edit/account-details'] = array(
    'title' => t('Edit Account Details'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('edit_account_details_form'),
    'access arguments' => array('add account'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Form for adding new accounts.
 */
function bullseye_account_new_form($form, &$form_state) {
  
  global $user;

  $form = array();
  $form['#parents'] = array();
  $form['#attributes']['class'][] = 'be-forms be-forms-custom';

  module_load_include('inc', 'field_collection', 'field_collection.pages');
  module_load_include('inc', 'node', 'node.pages');

  if (arg(2) == 'lead') {
    $form_title = t('Add New Lead');
  }
  elseif (arg(2) == 'prospect') {
    $form_title = t('Add New Prospect');
  }
  elseif (arg(2) == 'opportunity') {
    $form_title = t('Add New Opportunity');
  }
  elseif (arg(2) == 'deal-in-progress') {
    $form_title = t('Add New Deal in Progress');
  }

  $form['form_title'] = array(
    '#prefix' => '<div class="form-title">',
    '#suffix' => '</div>',
    '#markup' => '<h2>' . $form_title . '</h2>',
  );

  $form['profile_picture'] = array(
    '#type' => 'managed_file',
  );

  $form['firstname'] = array(
    '#type' => 'textfield',
    '#required' => TRUE,
    '#attributes' => array(
      'placeholder' => t('First Name'),
    ),
  );

  $form['middlename'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t('Middle Name'),
    ),
  );

  $form['lastname'] = array(
    '#type' => 'textfield',
    '#required' => TRUE,
    '#attributes' => array(
      'placeholder' => t('Last Name'),
    ),
  );

  $form['company'] = array(
    '#type' => 'textfield',
    '#required' => TRUE,
    '#title' => t('Company'),
    '#attributes' => array(
      'placeholder' => t('Add Company'),
    ),
  );

  $form['title'] = array(
    '#type' => 'textfield',
    '#required' => TRUE,
    '#title' => t('Title'),
    '#attributes' => array(
      'placeholder' => t('Add Title'),
    ),
  );

  $form['contact_type'] = array(
    '#type' => 'select',
    '#title' => t('Type'),
    '#options' => array(
      'accounts' => t('Account'),
      'referrals' => t('Referral Partner'),
      'producers' => t('Producer'),
    ),
    '#default_value' => 'accounts',
  );

  $form['owner'] = array(
    '#type' => 'textfield',
    '#title' => t('Owner'),
    '#attributes' => array(
      'placeholder' => t('Add Owner'),
    ),
  );

  $form['business_type'] = array(
    '#type' => 'textfield',
    '#title' => t('Business Type'),
    '#attributes' => array(
      'placeholder' => t('Business Type'),
    ),
  );

  $form['work_email'] = array(
    '#type' => 'textfield',
    '#title' => t('Work Email'),
    '#attributes' => array(
      'placeholder' => t('Add Email'),
    ),
  );

  $form['work_phone'] = array(
    '#type' => 'textfield',
    '#title' => t('Work Phone'),
    '#attributes' => array(
      'placeholder' => t('Add Phone'),
    ),
  );

  $form['mobile_phone'] = array(
    '#type' => 'textfield',
    '#title' => t('Mobile Phone'),
    '#attributes' => array(
      'placeholder' => t('Mobile Phone'),
    ),
  );

  $form['work_website'] = array(
    '#type' => 'textfield',
    '#title' => t('Work Website'),
    '#attributes' => array(
      'placeholder' => t('Add Website'),
    ),
  );

  $form['linkedin'] = array(
    '#type' => 'textfield',
    '#title' => t('LinkedIn'),
    '#attributes' => array(
      'placeholder' => t('Add Social'),
    ),
  );

  $form['facebook'] = array(
    '#type' => 'textfield',
    '#title' => t('Facebook'),
    '#attributes' => array(
      'placeholder' => t('Add Social'),
    ),
  );

  $form['address'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t('Street'),
    ),
  );

  $form['city'] = array(
    '#type' => 'textfield',
    '#attributes' => array(
      'placeholder' => t('City'),
    ),
  );

  $node = new stdClass();
  $node->type = 'accounts';

  // Getting the field "Tags" from accounts content type fields.
  $field1 = field_info_field('field_states');
  $instance1 = field_info_instance('node', 'field_states', 'accounts');
  $items1 = field_get_items('node', $node, 'field_states');
  $my_field1 = field_default_form('node', $node, $field1, $instance1, LANGUAGE_NONE, $items1, $form, $form_state);
  $form += (array) $my_field1;
  $form['field_states'][LANGUAGE_NONE]['#title'] = '';

  $form['zip_code'] = array(
    '#type' => 'textfield',
    '#weight' => 26,
    '#attributes' => array(
      'placeholder' => t('Zip Code'),
    ),
  );

  $form['visibility'] = array(
    '#type' => 'textfield',
    '#title' => t('Visibility'),
  );

  // Getting the field "Tags" from accounts content type fields.
  $field = field_info_field('field_tags');
  $instance = field_info_instance('node', 'field_tags', 'accounts');
  $items = field_get_items('node', $node, 'field_tags');
  $my_field = field_default_form('node', $node, $field, $instance, LANGUAGE_NONE, $items, $form, $form_state);
  $form += (array) $my_field;
  $form['field_tags'][LANGUAGE_NONE]['#attributes'] = array(
    'placeholder' => t('+ Enter groups separated by commas ...'),
  );

  $form['description'] = array(
    '#type' => 'textfield',
    '#title' => t('Description'),
    '#attributes' => array(
      'placeholder' => t('Add Description'),
    ),
    '#weight' => 29,
  );

  $form['submit_container'] = array(
    '#type' => 'container',
    '#weight' => 30,
  );

  $form['submit_container']['cancel'] = array(
    '#markup' => '<a class="gray-btn" href="/" onClick="parent.Lightbox.end();">Cancel</a>',
  );

  $form['submit_container']['submit'] = array(
    '#type' => 'submit',
    '#attributes' => array(
      'class' => array('green-btn'),
    ),
    '#value' => t('Save'),
  );

  return $form;
}

/**
 * Submit Handler for adding new leads.
 */
function bullseye_account_new_form_submit($form, &$form_state) {
  global $user;

  // Contact Details.
  $firstname = $form_state['values']['firstname'];
  $middlename = $form_state['values']['middlename'];
  $lastname = $form_state['values']['lastname'];
  $title = $form_state['values']['title'];
  $work_email = $form_state['values']['work_email'];
  $mobile_phone = $form_state['values']['mobile_phone'];
  $linkedin = $form_state['values']['linkedin'];
  $facebook = $form_state['values']['facebook'];
  $description = $form_state['values']['description'];

  // Company Details.
  $company = $form_state['values']['company'];
  $contact_type = $form_state['values']['contact_type'];
  $owner = $form_state['values']['owner'];
  $business_type = $form_state['values']['business_type'];
  $work_phone = $form_state['values']['work_phone'];
  $work_website = $form_state['values']['work_website'];
  $address = $form_state['values']['address'];
  $city = $form_state['values']['city'];
  $field_states = $form_state['values']['field_states'][LANGUAGE_NONE][0]['tid'];
  $zip_code = $form_state['values']['zip_code'];
  $visibility = $form_state['values']['visibility'];
  $tags = $form_state['values']['field_tags'][LANGUAGE_NONE];
  $tids = array();

  $node = new stdClass();
  $node->type = 'accounts';
  $node->uid = $user->uid;
  node_object_prepare($node);
  $node->language = LANGUAGE_NONE;

  $wrapper = entity_metadata_wrapper('node', $node);
  $wrapper->title->set($company);
  $wrapper->status->set(1);
  $wrapper->field_type->set($contact_type);
  $wrapper->field_owned_by->set($owner);
  $wrapper->field_type_of_business->set($business_type);
  $wrapper->field_work_phone->set($work_phone);
  $wrapper->field_work_website->set($work_website);
  $wrapper->field_street->set($address);
  $wrapper->field_city->set($city);
  $wrapper->field_states->set($field_states);
  $wrapper->field_postal_code->set($zip_code);
  $wrapper->field_visibility->set($visibility);
  if (arg(2) == 'lead') {
    $wrapper->field_account_status->set('lead');
    $wrapper->field_action_status->set('verify_sca_dbra');
    $wrapper->field_workflow_status->set('verification');
  }
  elseif (arg(2) == 'prospect') {
    $wrapper->field_account_status->set('prospect');
    $wrapper->field_action_status->set('send_email');
    $wrapper->field_workflow_status->set('engagement');
  }
  elseif (arg(2) == 'opportunity') {
    $wrapper->field_account_status->set('opportunity');
    $wrapper->field_action_status->set('request_specifications');
    $wrapper->field_workflow_status->set('plan_specification');
  }
  elseif (arg(2) == 'deal-in-progress') {
    $wrapper->field_account_status->set('deal_in_progress');
    $wrapper->field_action_status->set('draw_documents');
    $wrapper->field_workflow_status->set('generate_trust_agreement');
  }
    
  // Saving the tags.
  if (!empty($tags)) {
    foreach ($tags as $key => $value) {
      $tag = trim($value['name']);

      $result = db_query('SELECT t.tid FROM {taxonomy_term_data} t WHERE t.name = :name AND t.vid = 1', array(':name' => $tag));
      $record = $result->fetchAssoc();

      if (!empty($record)) {
        $tids[] = $record['tid'];
      }
      else {
        $term = new stdClass();
        $term->name = $value['name'];
        $term->vid = 1;
        taxonomy_term_save($term);
        $tids[] = $term->tid;
      }

    }
    $wrapper->field_tags->set($tids);
  }
  else {
    $wrapper->field_tags->set(array());
  }
  $wrapper->save();

  $nid = $wrapper->getIdentifier();
  $node = node_load($nid);

  // Saving the contact.
  $collection = entity_create('field_collection_item', array('field_name' => 'field_contacts'));
  $collection->setHostEntity('node', $node);
  $cwrapper = entity_metadata_wrapper('field_collection_item', $collection);
  $cwrapper->field_firstname->set($firstname);
  $cwrapper->field_middle_name->set($middlename);
  $cwrapper->field_lastname->set($lastname);
  $cwrapper->field_if_primary_contact->set('yes');
  $cwrapper->field_position->set($title);
  $cwrapper->field_email->set($work_email);
  $cwrapper->field_mobile_phone->set($mobile_phone);
  $cwrapper->field_linkedin_personal->set($linkedin);
  $cwrapper->field_facebook_personal->set($facebook);
  $cwrapper->field_details->set($description);

  // Producer Agreement file.
  if ($form_state['values']['profile_picture'] != 0) {
    $pp_file = file_load($form_state['values']['profile_picture']);
    $pp_file->display = 1;
    $pp_file = file_copy($pp_file, 'public://');
    $pp_file = (array) $pp_file;
    $cwrapper->field_profile_picture->set($pp_file);
  }

  $cwrapper->save();

  cache_clear_all('accounts_listing', 'cache');

  if (arg(2) == 'lead') {
    drupal_set_message('Successfully added new lead.');
    cache_clear_all('leads_accounts_listing', 'cache');
  }
  elseif (arg(2) == 'prospect') {
    drupal_set_message('Successfully added new prospect.');
    cache_clear_all('prospects_accounts_listing', 'cache');
  }
  elseif (arg(2) == 'opportunity') {
    drupal_set_message('Successfully added new opportunity.');
    cache_clear_all('opportunity_accounts_listing', 'cache');
  }
  elseif (arg(2) == 'deal-in-progress') {
    drupal_set_message('Successfully added new deal in progress.');
    cache_clear_all('deal_in_progress_accounts_listing', 'cache');
  }

}

/**
 * Form for editing account details.
 */
function edit_account_details_form($form, &$form_state) {
  
  global $user;

  $company = Bullseye::getCompanyNameByNid(arg(2));
  $people = Bullseye::getAccountPeople(arg(2));
  $primary_contact = '';
  $phone = Bullseye::getPhoneNumberByNid(arg(2));
  $website = Bullseye::getWebsiteByNid(arg(2));
  $address = Bullseye::getStreetAddressByNid(arg(2));
  $city = Bullseye::getCityByNid(arg(2));
  $state = Bullseye::getStateByNid(arg(2));
  $zip_code = Bullseye::getZipCodeByNid(arg(2));
  $business_type = Bullseye::getBusinessTypeByNid(arg(2));
  $tags = Bullseye::getTagsByNid(arg(2));
  $contacts = array();

  // Getting the contacts of the account.
  foreach ($people as $key => $value) {
    $name = $value->field_firstname_value . ' ' . $value->field_lastname_value;
    $contacts[$value->field_contacts_value] = $name . ' - ' . $value->field_email_value;
    if ($value->field_if_primary_contact_value == 'yes') {
      $primary_contact = $value->field_contacts_value;
    }
  }

  $node = node_load(arg(2));

  module_load_include('inc', 'field_collection', 'field_collection.pages');
  module_load_include('inc', 'node', 'node.pages');

  $form = array();
  $form['#parents'] = array();
  $form['#attributes']['class'][] = 'be-forms be-forms-custom';

  $form['nid'] = array(
    '#type' => 'hidden',
    '#value' => $node->nid,
  );

  $form['form_title'] = array(
    '#prefix' => '<div class="form-title">',
    '#suffix' => '</div>',
    '#markup' => '<h2>' . t('Edit Account Details') . '</h2>',
  );

  $form['company'] = array(
    '#type' => 'textfield',
    '#title' => t('Company Name'),
    '#required' => TRUE,
    '#attributes' => array(
      'placeholder' => t('Add Company Name'),
    ),
    '#default_value' => $company,
  );

  $form['primary_contact'] = array(
    '#type' => 'select',
    '#title' => t('Primary Contact'),
    '#options' => $contacts,
    '#default_value' => $primary_contact,
  );

  $form['phone'] = array(
    '#type' => 'textfield',
    '#title' => t('Phone Number'),
    '#attributes' => array(
      'placeholder' => t('Add Phone Number'),
    ),
    '#default_value' => $phone,
  );

  $form['website'] = array(
    '#type' => 'textfield',
    '#title' => t('Website'),
    '#attributes' => array(
      'placeholder' => t('Add Website'),
    ),
    '#default_value' => $website,
  );

  $form['address'] = array(
    '#type' => 'textfield',
    '#title' => t('Corporate Street Address'),
    '#default_value' => $address,
  );

  $form['city'] = array(
    '#type' => 'textfield',
    '#title' => t('City'),
    '#default_value' => $city,
  );

  // Getting the field "Tags" from accounts content type fields.
  $field1 = field_info_field('field_states');
  $instance1 = field_info_instance('node', 'field_states', 'accounts');
  $items1 = field_get_items('node', $node, 'field_states');
  $my_field1 = field_default_form('node', $node, $field1, $instance1, LANGUAGE_NONE, $items1, $form, $form_state);
  $form += (array) $my_field1;

  $form['zip_code'] = array(
    '#type' => 'textfield',
    '#title' => t('Zip Code'),
    '#default_value' => $zip_code,
    '#weight' => 26,
  );

  $form['business_type'] = array(
    '#type' => 'textfield',
    '#title' => t('Business Type'),
    '#default_value' => $business_type,
    '#weight' => 27,
  );

  // Getting the field "Tags" from accounts content type fields.
  $field = field_info_field('field_tags');
  $instance = field_info_instance('node', 'field_tags', 'accounts');
  $items = field_get_items('node', $node, 'field_tags');
  $my_field = field_default_form('node', $node, $field, $instance, LANGUAGE_NONE, $items, $form, $form_state);
  $form += (array) $my_field;
  $form['field_tags'][LANGUAGE_NONE]['#attributes'] = array(
    'placeholder' => t('+ Enter groups separated by commas ...'),
  );

  $form['submit_container'] = array(
    '#type' => 'container',
    '#weight' => 29,
  );

  $form['submit_container']['cancel'] = array(
    '#markup' => '<a class="gray-btn" href="/" onClick="parent.Lightbox.end();">Cancel</a>',
  );

  $form['submit_container']['submit'] = array(
    '#type' => 'submit',
    '#attributes' => array(
      'class' => array('green-btn'),
    ),
    '#value' => t('Save'),
  );

  return $form;
}

/**
 * Submit Handler for editing account details.
 */
function edit_account_details_form_submit($form, &$form_state) {

  global $base_url;

  $nid = $form_state['values']['nid'];
  $company = $form_state['values']['company'];
  $primary_contact = $form_state['values']['primary_contact'];
  $phone = $form_state['values']['phone'];
  $website = $form_state['values']['website'];
  $address = $form_state['values']['address'];
  $city = $form_state['values']['city'];
  $field_states = $form_state['values']['field_states'][LANGUAGE_NONE][0]['tid'];
  $zip_code = $form_state['values']['zip_code'];
  $business_type = $form_state['values']['business_type'];
  $tags = $form_state['values']['field_tags'][LANGUAGE_NONE];
  $tids = array();

  $wrapper = entity_metadata_wrapper('node', $nid);
  $wrapper->title->set($company);
  $wrapper->field_company->set($company);
  $wrapper->field_work_phone->set($phone);
  $wrapper->field_work_website->set($website);
  $wrapper->field_street->set($address);
  $wrapper->field_city->set($city);
  $wrapper->field_states->set($field_states);
  $wrapper->field_postal_code->set($zip_code);
  $wrapper->field_type_of_business->set($business_type);

  // Saving the tags.
  if (!empty($tags)) {
    foreach ($tags as $key => $value) {
      $tag = trim($value['name']);

      $result = db_query('SELECT t.tid FROM {taxonomy_term_data} t WHERE t.name = :name AND t.vid = 1', array(':name' => $tag));
      $record = $result->fetchAssoc();

      if (!empty($record)) {
        $tids[] = $record['tid'];
      }
      else {
        $term = new stdClass();
        $term->name = $value['name'];
        $term->vid = 1;
        taxonomy_term_save($term);
        $tids[] = $term->tid;
      }

    }
    $wrapper->field_tags->set($tids);
  }
  else {
    $wrapper->field_tags->set(array());
  }

  $status = $wrapper->field_account_status->value();
  $contacts = $wrapper->field_contacts->value();

  $wrapper->save();

  // For saving the primary contact.
  foreach ($contacts as $key => $contact) {
    $collection = field_collection_item_load($contact->item_id);
    $cwrapper = entity_metadata_wrapper('field_collection_item', $collection);
    if ($contact->item_id == $primary_contact) {
      $cwrapper->field_if_primary_contact->set('yes');
    }
    else {
      $cwrapper->field_if_primary_contact->set('no');
    }
    $cwrapper->save();
  }

  cache_clear_all('leads_accounts_listing', 'cache');
  cache_clear_all('primary_contact_' . $nid, 'cache');
  cache_clear_all('contacts_' . $nid, 'cache');

  drupal_set_message('Successfully updated account details.');

  $alias = drupal_get_path_alias('node/' . $nid);
  $alias = substr($alias, 8);

  // Close the lightbox.
  print '<script>parent.location = "' . $base_url . '/company/' . $alias . '?from=' . $status . '";</script>';
  print '<script>parent.Lightbox.end();</script>';
  die();
  
}

/**
 * Implements hook_permission().
 */
function bullseye_account_permission() {
  return array(
    'add account' => array(
      'title' => t('Add an Account'),
      'description' => t('Allow user to an account.'),
    ),
  );
}

/**
 * Implements hook_node_update().
 *
 * Clear the cache after updat
 */
function bullseye_account_node_update($node) {
  if ($node->type == 'account' && $node->field_account_status[LANGUAGE_NONE][0]['value'] == 'prospect') {
    // Update the node.
    node_save($node);
    // Invalidate the existing cache to make sure that
    // the newly added one will get indexed too.
    cache_clear_all('prospect_accounts_listing', 'cache');
  }
}

/**
 * Implements hook_node_insert().
 */
function bullseye_account_node_insert($node) {
  if ($node->type == 'account' && $node->field_account_status[LANGUAGE_NONE][0]['value'] == 'prospect') {
    // Update the node.
    node_save($node);
    // Invalidate the existing cache to make sure that
    // the newly added one will get indexed too.
    cache_clear_all('prospect_accounts_listing', 'cache');
  }
}
